import numpy as np
import pandas as pd


def exploit_data(csv_data, csv_pivot, sep, point_function):
    """Use scraped data to produce the pivot table.

    Parameters
    ----------
    csv_data: str
        The csv file where the data is saved.
    csv_pivot: str
        The csv file where the pivot table will be saved.
    sep: str
        Separator for the csv files.
    point_function: callable
        A function. Input: a rank in the monthly top 100. Output: a number of points.
    """
    df = pd.read_csv(csv_data, sep=sep)
    df['points'] = df.position.apply(point_function)
    df['months in top 100'] = 1
    pivot = pd.pivot_table(df, index=['title', 'url', 'release_date'],
                           aggfunc={'points': np.sum, 'months in top 100': np.sum, 'position': np.mean})
    pivot.sort_values(by='points', ascending=False, inplace=True)
    pivot = pivot.reindex(columns=['points', 'months in top 100', 'position'])
    pivot.rename({'position': 'average position in top 100'}, inplace=True, axis='columns')
    pivot.reset_index(inplace=True)
    pivot.insert(loc=0, column='rank', value=pivot.index + 1)
    pivot['release_date'] = pd.to_numeric(pivot['release_date'], downcast='integer')
    pivot.to_csv(csv_pivot, sep=sep, index=False)
